name: Build and Push Docker Images

on:
  push:
    tags:
      - 'v*'

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract tag info
        id: tag
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          # If version contains a hyphen, it's a pre-release (e.g. 1.0.0-beta.1)
          if [[ "$VERSION" == *-* ]]; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image tags
        id: tags
        run: |
          VERSION="${{ steps.tag.outputs.version }}"
          PREFIX="${{ env.DOCKERHUB_USERNAME }}"

          WG="${PREFIX}/wg-portal-wireguard:${VERSION}"
          BE="${PREFIX}/wg-portal-backend:${VERSION}"
          FE="${PREFIX}/wg-portal-frontend:${VERSION}"

          if [[ "${{ steps.tag.outputs.is_prerelease }}" == "false" ]]; then
            WG="${WG},$PREFIX/wg-portal-wireguard:latest"
            BE="${BE},$PREFIX/wg-portal-backend:latest"
            FE="${FE},$PREFIX/wg-portal-frontend:latest"
          fi

          echo "wireguard=$WG" >> "$GITHUB_OUTPUT"
          echo "backend=$BE" >> "$GITHUB_OUTPUT"
          echo "frontend=$FE" >> "$GITHUB_OUTPUT"

      - name: Build and push wireguard
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.wireguard
          push: true
          tags: ${{ steps.tags.outputs.wireguard }}
          cache-from: type=gha,scope=wireguard
          cache-to: type=gha,mode=max,scope=wireguard

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.backend
          push: true
          tags: ${{ steps.tags.outputs.backend }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.frontend
          push: true
          tags: ${{ steps.tags.outputs.frontend }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend
